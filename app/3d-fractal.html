<!--
    3D FRACTAL - MICROTONAL SYNTH 1.0
    JBC
-->
<!DOCTYPE html>
<html><head>
	<title>3D Fractal Microtonal Synth</title>
	<meta charset="utf-8">
    <meta name="author" content="J.B.Cristian">
	<script type="text/javascript" src="gl-matrix-min.js"></script>
<style>

body {	background-color: #151515;  font-family: Consolas; font-size:10px;	margin:0; padding:0; scrollbar-color:#333 #444;
  scrollbar-width: 10px; }
#container { text-align: center;  position: relative; display: inline-block; width:1024px; height: 600px;}
#glcanvasframe{position: relative; width: 512px; height: 512px; }
.panel {background-color: #000;   color:#999;width: 512px; text-align: left; position:absolute; padding:5px;}
.title {background-color: rgba(0,0,0,0.5); color:#333; }
.optTitle {color:#fff; border-top:2px solid #303030; }
.content{ line-height: 25px; text-align: right;}
.col-pos{display: inline-block; line-height: 15px; width: 80px; vertical-align: middle;}
.col-posb{display: inline-block; line-height: 25px; vertical-align: top;}
input[type="radio"]{margin:0; vertical-align: middle;}
input[type="checkbox"]:hover{border-color:#999;}
input[type="checkbox"]{margin:0px;vertical-align: middle;}
input[type="checkbox"]{
  -webkit-appearance: none;
  border:1px solid #333;
  width: 10px;height: 10px;
}
input[type="checkbox"]:checked:after{
  width: 10px;
  height: 10px;
  display: block;
  content: '\2714';
  color:#ccc;
  font-size:8px;
  line-height: 8px;
}
input[type="number"]{-webkit-appearance:textfield;}
input[type="number"]:hover{-webkit-appearance:initial;}
#playingNotes span{display:inline-block; width: 5px; height: 5px; border-radius: 100%; }
#playingNotes {width: 40px; text-align: right;}
#playing_x{border:1px solid red}
#playing_y{border:1px solid green}
#playing_z{border:1px solid blue}
#playing_d{border:1px solid gray}
.formant{position: relative;}
.formant output{color:red;}
.inst-select{display: inline-block;}
.epanel{padding: 10px;
background: rgba(50,50,50,0.5);}
#glcanvas{cursor:crosshair;}
.rangeValue{display: inline-block; color:#FFF;width:40px;overflow: hidden; vertical-align: middle;}
.expandTitle{cursor: pointer;}
.expandTitle:hover{background-image: linear-gradient(to right, rgba(100,100,100,0.2), rgba(120,120,120,0.3));}
input[type="range"]::-moz-range-thumb { width:5px;height: 10px; background-color:#54a754; border-radius: 0px;}
input[type="range"]::-moz-range-thumb:hover { background-color:#0ef20e;}
input[type="range"] {border:1px solid #333; background: #121; height: 5px;width:100px; vertical-align: middle; margin:4px;}
input[type="number"]{width: 80px; background-color: #0c0406; border:1px solid #333; color:#888; font-size:11px;}
input[type="radio"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  display: inline-block;
  vertical-align: middle;
  border-radius: 100%;
}
input[type="radio"] {
  border: 1px solid #555;
  width: 10px;
  height: 10px;
  padding: 2px;
}
input[type="radio"]:checked {
  border: 1px solid #ccc;
  background: #ccc;
  background-clip: content-box;
}
input[type="radio"]:hover {
	border: 1px solid #ccc;
}
#chordCompass{width: 100px;position: relative;float: right;
vertical-align: middle;height: 100px; transform: rotate(180deg); margin-top: -10px;
background: #0A0A0A;
border-radius: 100%;}
#chordCompass #edo12 div {position: absolute; height: 40px; border-left:.5px solid #333; width: 1px; top:50px; left:50px; transform-origin: 0% 0% 0;
	}
#marks div{position: absolute; display: block; width:1px; height: 10px;}
#notemark-r{top:50px;left:50px; background-color: red; transform-origin:0px 0px 0px; transform:rotate(0deg)}
#notemark-g{top:60px;left:50px; background-color: green; transform-origin:0px -10px 0px; transform:rotate(80deg)}
#notemark-b{top:70px;left:50px; background-color: blue; transform-origin:0px -20px 0px; transform:rotate(303deg)}
#notemark-d{top:80px;left:50px; background-color: gray; transform-origin:0px -30px 0px; transform:rotate(123deg)}
#rings div { border-radius: 100%; top:50px;left:50px; position:absolute; border:.5px solid #333; }
#ring-r{ width: 10px; height: 10px; margin-top:-6px; margin-left:-6px; }
#ring-g{ width: 30px; height: 30px; margin-top:-16px; margin-left:-16px; }
#ring-b{ width: 50px; height: 50px; margin-top:-26px; margin-left:-26px; }
#ring-d{ width: 70px; height: 70px; margin-top:-36px; margin-left:-36px; }
button{border: 1px solid #333;font-size: 10px;background: #333;color: #555;line-height: 15px;}
button:hover{border:1px solid #555;}
::-webkit-scrollbar{width: 10px;height: 10px; }
::-webkit-scrollbar-track-piece {background-color:#222;}
::-webkit-scrollbar-thumb {background-color: #444;border:2px solid #333; border-radius: 3px;}

</style>
</head>
<body onload="start()" >
	<div id="container">
		<div class="panel" style="width: 256px; background-image: linear-gradient(to bottom, #19181f, #1c1b20);  min-height: 810px;">
			<div class="title">FRACTAL SETTINGS</div>
			<div class="content">
				<label for="renderONOFF">RENDER ON/OFF</label>
				<input type="checkbox" id="renderONOFF" checked>
				<div class="optTitle">Quality:</div>
				<div class="opts">
					<label for="antiAlias">AntiAliasing: </label>
					<input type="checkbox" id="antiAlias">
					<br/>
					<label for="aoswitch">Ambient Occlusion: </label>
					<input type="checkbox" id="aoswitch">
					<br/>
					<label for="rm-steps">Ray Marching Steps:</label>
					<input id="rm-steps" type="number" value="96" min="1" max="1024" step="1">
					<br/>
					<label for="surf-thres">Surface threshold:</label>
					<input id="surf-thres" type="number" value=".0001" min="0.00001" max=".1" step="0.00001">
					<br/>
					<label for="normalSmooth">Normal Smooth:</label>
					<input id="normalSmooth" type="number" value=".0001" min="0.0001" max="1." step="0.0001">
					<br/>
					<label for="focal-length">Focal Length:</label>
					<input id="focal-length" type="number" value="1.25" min=".1" max="200" step="0.01">
					<br/>
					<label for="clip-near">Clip Near:</label>
					<input id="clip-near" type="number" value=".001" min="0" max="1" step="0.001">
					<br/>
					<label for="clip-far">Clip Far:</label>
					<input id="clip-far" type="number" value="50" min="10" max="100" step="0.1">			

				</div>
				<div class="optTitle">Navigation:</div>
				<div class="opts">
					<label for="key-speed">Keys Speed:</label>
					<input id="key-speed" type="number" value="1" min="-1" max="2" step="0.01">
					<br/>
					<label for="key-wasd">Move with Arrow Keys: (SHIFT ON/OFF)</label>
					<input id="key-wasd" type="checkbox" checked>
					<br/>
					<label for="mouse-speed">Mouse Speed:</label>
					<input id="mouse-speed" type="number" value="1" min="0" max="2" step="0.001">
					<br/>
					<label for="pan-mouse">Move with Mouse: (CTRL ON/OFF)</label>
					<input id="pan-mouse" type="checkbox">

					<br/>
					<button onclick="initCamera()">Reset View</button>

				</div>
				<div class="optTitle">Fractal Options:</div>
				<div class="opts">
					<label for="iter">Iterations:</label>
					<input id="iter" type="number" value="12" min="8" max="20" step="1">
					<br/>
					<label for="addX">X: </label>
					<input type="number" id="addX" value="-1.5" min="-5" max="5" step="0.01">
					<br/>
					<label for="addX">Y: </label>
					<input type="number" id="addY" value="-1.5" min="-5" max="5" step="0.01">
					<br/>
					<label for="addX">Z: </label>
					<input type="number" id="addZ" value="-1.5" min="-5" max="5" step="0.01">
					<br/>
					<label for="addC">Add Global: </label>
					<input type="checkbox" id="addC" >
					<br/>
					<label for="repeatFractal">Repeat: </label>
					<input type="checkbox" id="repeatFractal" > 
					<label for="repeatDistance">Distance: </label>
					<input type="number" id="repeatDistance" value="4" min="0.1" max="20" step="0.1">
				</div>
				<div class="optTitle">Shading: </div>
				<div class="opts">
					Surface Color: <br/>
					<label for="color-normals">Normals</label>
					<input type="radio" name="colorOpt"  id="color-normals" checked> | 
					<label for="color-depth">Depth</label>
					<input type="radio" name="colorOpt" id="color-depth"> | 
					<label for="color-solid">Solid</label>
					<input type="radio" name="colorOpt" id="color-solid"> <br/>
					<label for="color-r">R: </label>
					<input type="number" id="color-r" value="1.0" min="0" max="1.0" step="0.01" style="width:40px;">
					<label for="color-g">G: </label>
					<input type="number" id="color-g" value="0.1" min="0" max="1.0" step="0.01" style="width:40px;">
					<label for="color-b">B: </label>
					<input type="number" id="color-b" value="0.1" min="0" max="1.0" step="0.01" style="width:40px;">
					<br/>
					Lights: <br/>
					<label for="mainLightInt">Main Light Intensity: </label>
					<input type="number" value="20" min="0" max="100" step="1" id="mainLightInt"><br/>
					<label for="clickLightInt">Click Light Intensity: </label>
					<input type="number" value="50" min="0" max="100" step="1" id="clickLightInt"><br/>
					<label for="clickLightSize">Click Light Size: </label>
					<input type="number" value="0.05" min="0" max="1" step="0.01" id="clickLightSize">

				</div>
			</div>
		</div>
		<div class="panel" style="left:267px; background-image: linear-gradient(to bottom, #131313, #000);">
			<div class="title">RENDER</div>
			<div class="content">
				<div id="glcanvasframe">
					<canvas id="glcanvas" width="512" height="512">
					</canvas>
				</div>
			</div>
		</div>
		<div class="panel" style="left:267px; top:535px;" >
			<div class="content" style=" text-align: left;">
				<div class="opts" style="padding:32px 10px;">
					<div class="col-pos" >
						<span>Orginal:</span><br/>
						<span style="color:red;" id="posx_o">X: </span><br/>
						<span style="color:green;" id="posy_o">Y: </span><br/>
						<span style="color:blue;" id="posz_o">Z: </span><br/>
                        <span style="color:gray" id="posd_o">D: </span>
					</div>
                    <div class="col-pos">
						<div id ="scaleMode">
							<label for="modeLin">Lin</label> 
							<input type="radio" id="modeLin" name="scaleMode" checked> 
							<label for="modeLog">Log</label> 
							<input type="radio" id="modeLog" name="scaleMode">
						</div>
                        <label for="modpoint">Repeat: </label>
                        <input id="modpoint" type="number" value="8" min="0" max="50" step="1" style="width:40px;">
						<!--br/>
						<label for="expansion">Expand: </label>
                        <input type="number" id="expansion" value="1" min="0" max="10000" step=".1" style="width:40px;"-->
						<br/>
						<label for="pointMult">Multiply: </label>
						<input type="number" id="pointMult" value="100" min="0" max="10000" step="1" style="width:40px;">
                    </div>
					<div class="col-pos">
						<span>Final Freq: </span><br/>
						<span id="posx_f">X: </span><br/>
						<span id="posy_f">Y: </span> <br/>
						<span id="posz_f">Z: </span> <br/>
                        <span id="posd_f">D: </span>
					</div>
					<div class="col-pos" id="playingNotes" >
						<div style="display:inline-block;"></div><br/>
						<span id="playing_x"></span><br/>
						<span id="playing_y"></span><br/>
						<span id="playing_z"></span><br/>
                        <span id="playing_d"></span>
					</div>
					<div id="chordCompass">
						<div id="edo12">
							<div id="cc12-0" style="transform: rotate(30deg);"></div>
							<div id="cc12-1" style="transform: rotate(60deg);"></div>
							<div id="cc12-2" style="transform: rotate(90deg);"></div>
							<div id="cc12-3" style="transform: rotate(120deg);"></div>
							<div id="cc12-4" style="transform: rotate(150deg);"></div>
							<div id="cc12-5" style="transform: rotate(180deg);"></div>
							<div id="cc12-6" style="transform: rotate(210deg);"></div>
							<div id="cc12-7" style="transform: rotate(240deg);"></div>
							<div id="cc12-8" style="transform: rotate(270deg);"></div>
							<div id="cc12-9" style="transform: rotate(300deg);"></div>
							<div id="cc12-10" style="transform: rotate(330deg);"></div>
							<div id="cc12-11" style="transform: rotate(360deg);"></div>
						</div>
						<div id="rings">
							<div id="ring-r"></div>
							<div id="ring-g"></div>
							<div id="ring-b"></div>
							<div id="ring-d"></div>
						</div>
						<div id="marks">
							<div id="notemark-r"></div>
							<div id="notemark-g"></div>
							<div id="notemark-b"></div>
							<div id="notemark-d"></div>
						</div>
						
					</div>
				</div>
			</div>

			<div class="title">INPUT SETTINGS</div>
			<div class="content" style=" text-align: left; background-color: #121015;" onclick="updateSlots();">
				<div class="opts" style="padding:10px;">
					<div class="col-posb" style="padding-right: 15px; ">
						[ LEFT CLICK ]<br/>
						[ MIDDLE CLICK ]<br/>
						[ KEY SET 1 ]<br/>
						[ KEY SET 2 ]
					</div>
					<div class="col-posb" style="padding:0px 10px; border-left:1px dotted #333;">
						Slot: 
						1 <input type="radio" name="lc_slot" checked> &nbsp;
						2 <input type="radio" name="lc_slot"> &nbsp;
						3 <input type="radio" name="lc_slot"> &nbsp;
						4 <input type="radio" name="lc_slot"> &nbsp;
						<br/>
						Slot: 
						1 <input type="radio" name="mc_slot"> &nbsp;
						2 <input type="radio" name="mc_slot"> &nbsp;
						3 <input type="radio" name="mc_slot" checked> &nbsp;
						4 <input type="radio" name="mc_slot"> &nbsp;
						<br/>
						Slot: 
						1 <input type="radio" name="ks1_slot" > &nbsp;
						2 <input type="radio" name="ks1_slot" checked> &nbsp;
						3 <input type="radio" name="ks1_slot"> &nbsp;
						4 <input type="radio" name="ks1_slot"> &nbsp;
						<br/>
						Slot: 
						1 <input type="radio" name="ks2_slot" > &nbsp;
						2 <input type="radio" name="ks2_slot"> &nbsp;
						3 <input type="radio" name="ks2_slot"> &nbsp;
						4 <input type="radio" name="ks2_slot" checked> &nbsp;
						
					</div>
					<div class="col-posb" onclick="updatePlayClicks();">
						<label for="lc_playx">X: </label>
						<input type="checkbox" id="lc_playx" checked> &nbsp;
						<label for="lc_playy">Y: </label>
						<input type="checkbox" id="lc_playy" checked> &nbsp;
						<label for="lc_playz">Z: </label>
						<input type="checkbox" id="lc_playz" checked> &nbsp;
						<label for="lc_playd">D: </label>
						<input type="checkbox" id="lc_playd" > 
						<br/>
						<label for="mc_playx">X: </label>
						<input type="checkbox" id="mc_playx"> &nbsp;
						<label for="mc_playy">Y: </label>
						<input type="checkbox" id="mc_playy"> &nbsp;
						<label for="mc_playz">Z: </label>
						<input type="checkbox" id="mc_playz"> &nbsp;
						<label for="mc_playd">D: </label>
						<input type="checkbox" id="mc_playd" checked>
					</div>
					<!--div class="col-posb">
						<label for="spacing">Note Spacing(in frames)</label>
						<input type="number" id="spacing" value="1" min="1" max="50" step="1">
					</div-->
				</div>
			</div>
		</div>

		<div class="panel" style="width: 560px; left:790px; background-image: linear-gradient(to bottom, #2b2836, #1c1b20); height: 810px; overflow-y:scroll;">
			<div class="title">SYNTH SETTINGS</div>
			<div class="content" onclick="updateASRL(); updateDelay(); ">
				<div class="optTitle">Master</div>
				<div>
					<label for="pan3d">Enable 3D Sound: </label>
				<input type="checkbox" id="pan3d" checked>
				</div>
				<label for="masterVol">Volume</label>
				<input type="range" id="masterVol" value=".8" min="0" max="1" step="0.1">

				<div style="background-color: rgba(10,10,10,0.8); margin-bottom:5px; padding:6px; border-top:1px solid #333;">
					<div class="optTitle" style="border:none;">Instrument [1]</div>
					<div class="instrument" id="ins1">
						<div class="instOpt">
							<label for="fVolume">Volume: </label>
							<input type="range" value ="0.5" min="0" max="1" step="0.01" id="fVolume">
							<label for="fPan">Pan L/R:</label>
							<input type="range" value="0" min="-1" max="1" step="0.01" id="fPan" style="width: 50px;">
							<br/>
							<div class="expandTitle" onclick="toggleOptions(this)">Envelope: +</div>
							<div id="fEnvelope" style="display:none;">
								<label for="fAttack">Attack: </label>
								<input type="range" value ="0.35" min="0.01" max="1" step="0.01" id="fAttack" style="width: 50px;">
								<label for="fRelease">Release: </label>
								<input type="range" value ="0.5" min="0.01" max="1" step="0.01" id="fRelease" style="width: 50px;">
								<label for="fNLength">Note Length: </label>
								<input type="range" value ="1" min="0.01" max="2" step="0.01" id="fNLength" style="width: 50px;">
							</div>
						</div>
						<div class="instFx" style="border-bottom: 0px solid #444;">
							<div class="expandTitle" onclick="toggleOptions(this)"> Effects: +</div>
							<div id="fEffects" style="display:none;">
								<input type="checkbox" id="i1fx" checked> &nbsp;&nbsp;
								<label for="fDelayTime">Delay Time:</label>
								<input type="number" value="0.3" min="0" max="2" step="0.01" id="fDelayTime" style="width: 50px;"> 
								<label for="fDelayFeedback">Delay Feedback:</label>
								<input type="range" value="0.5" min="0" max="1" step="0.01" id="fDelayFeedback" style="width: 50px;">
								<label for="fDelayAmount">Delay Amount: </label>
								<input type="range" value="0.5" min="0" max="1" step="0.01" id="fDelayAmount" style="width: 50px;">
							</div>
						</div>
						<div class="instAdv" onclick="updateInsts();">
							<div class="inst-select">
								<input type="radio" name="ins1_sel"> Sine | 
								<input type="radio" name="ins1_sel"> Square |
								<input type="radio" name="ins1_sel"> Triangle |
								<input type="radio" name="ins1_sel"> Saw |
								<input type="radio" name="ins1_sel" checked>
							</div>
							<div class="expandTitle" style="display:inline-block; border:none" onmousedown="toggleOptions(this)">Wavetable from formants: +</div>
							<div id="gWavetable" class="epanel" onclick="updateFF()" style="display:none; ">
								<div class="formantsList" >
									
									<div class="formant">
										<label for="f1freq">FREQ</label>
										<input type="range" id="f1freq" value="500" min="1" max="8000" step="1">
										<label for="f1exp">EXP</label>
										<input type="range" id="f1exp" value="0.005" min="0.00001" max=".01" step=".00001">
										<label for="f1coef">COEFF</label>
										<input type="range" id="f1coef" value="1" min=".0" max="2" step=".01" style="width: 50px;">
									</div>
									<div class="formant">
										<label for="f2freq">FREQ</label>
										<input type="range" id="f2freq" value="900" min="1" max="8000" step="1">
										<label for="f2exp">EXP</label>
										<input type="range" id="f2exp" value="0.0025" min="0.00001" max=".01" step=".00001">
										<label for="f2coef">COEFF</label>
										<input type="range" id="f2coef" value="1" min=".0" max="2" step=".01" style="width: 50px;">
									</div>
									<div class="formant">
										<label for="f3freq">FREQ</label>
										<input type="range" id="f3freq" value="2100" min="1" max="8000" step="1">
										<label for="f3exp">EXP</label>
										<input type="range" id="f3exp" value="0.0015" min="0.00001" max=".01" step=".00001">
										<label for="f3coef">COEFF</label>
										<input type="range" id="f3coef" value="1" min=".0" max="2" step=".01" style="width: 50px;">
									</div>
									<div class="formant">
										<label for="f4freq">FREQ</label>
										<input type="range" id="f4freq" value="3700" min="1" max="8000" step="1">
										<label for="f4exp">EXP</label>
										<input type="range" id="f4exp" value="0.0005" min="0.00001" max=".01" step=".00001">
										<label for="f4coef">COEFF</label>
										<input type="range" id="f4coef" value="1" min=".0" max="2" step=".01" style="width: 50px;">
									</div>
									<div class="formant">
										<label for="f5freq">FREQ</label>
										<input type="range" id="f5freq" value="4700" min="1" max="8000" step="1">
										<label for="f5exp">EXP</label>
										<input type="range" id="f5exp" value="0.00015" min="0.00001" max=".01" step=".00001">
										<label for="f5coef">COEFF</label>
										<input type="range" id="f5coef" value="1" min=".0" max="2" step=".01" style="width: 50px;">
									</div>
								</div>
								<label for="wtff_numHarmonics">Harmonics: </label>
								<input type="number" id="wtff_numHarmonics" value="64" min="1" max="128" step="1" style="width: 50px;"> 
								<label for="wtff_attenuatorPow">Attenatuor: </label>
								<input type="number" id="wtff_attenuator" value="1" min=".01" max="3" step=".005" style="width: 50px;">
								<label for="wtff_bandwith">Bandwith: </label>
								<input type="number" id="wtff_bandwith" value="50" min="1" max="240" step="1" style="width: 50px;">
								<label for="wtff_bandwithScale">Bw scale: </label>
								<input type="number" id="wtff_bandwithScale" value="1" min="0.01" max="200" step="0.01" style="width: 50px;">
							</div>
						</div>
						
					</div>
				</div>

				<div style="background-color: rgba(15,25,25,0.6);  margin-bottom:5px; padding:6px; border-top:1px solid #333;">
					<div class="optTitle" style="border:none;">Instrument [2]</div>
					<div class="instrument" id="ins2">
						<div class="instOpt">
							<label for="gVolume">Volume: </label>
							<input type="range" value ="0.1" min="0" max="1" step="0.01" id="gVolume">
							<label for="gPan">Pan L/R:</label>
							<input type="range" value="0" min="-1" max="1" step="0.01" id="gPan" style="width: 50px;">
							<br/>
							<div class="expandTitle" onmousedown="toggleOptions(this)">Envelope: +</div>
							<div id="gEnvelope" style="display:none;">
								<label for="gAttack">Attack: </label>
								<input type="range" value ="0.1" min="0.01" max="1" step="0.01" id="gAttack" style="width: 50px;">
								<label for="gRelease">Release: </label>
								<input type="range" value ="0.2" min="0.01" max="1" step="0.01" id="gRelease" style="width: 50px;">
								<label for="gNLength">Note Length: </label>
								<input type="range" value ="0.3" min="0.01" max="1" step="0.01" id="gNLength" style="width: 50px;">
							</div>
						</div>
						<div class="instFx" style="border-bottom: 0px solid #444;">
							<div class="expandTitle" onmousedown="toggleOptions(this)"> Effects: +</div>
							<div id="gEffects" style="display:none;">
								<input type="checkbox" id="i2fx" checked> &nbsp;&nbsp;
								<label for="gDelayTime">Delay Time:</label>
								<input type="number" value="0.1" min="0" max="2" step="0.01" id="gDelayTime" style="width: 50px;"> 
								<label for="gDelayFeedback">Delay Feedback:</label>
								<input type="range" value="0.2" min="0" max="1" step="0.01" id="gDelayFeedback" style="width: 50px;">
								<label for="gDelayAmount">Delay Amount: </label>
								<input type="range" value="0.2" min="0" max="1" step="0.01" id="gDelayAmount" style="width: 50px;">
							</div>
						</div>
						<div class="instAdv"  onclick="updateInsts();">
							<div class="inst-select">
								<input type="radio" name="ins2_sel"> Sine | 
								<input type="radio" name="ins2_sel" checked> Square |
								<input type="radio" name="ins2_sel"> Triangle |
								<input type="radio" name="ins2_sel"> Saw |
								<input type="radio" name="ins2_sel">
							</div>
							<div class="expandTitle" style="display: inline-block; border:none;" onmousedown="toggleOptions(this)">Wavetable from formants: +</div>
							<div id="gWavetable" onclick="updateGG()" style="display:none;" class="epanel">
								<div class="formantsList" >
									<div class="formant">
										<label for="g1freq">FREQ</label>
										<input type="range" id="g1freq" value="100" min="1" max="8000" step="1">
										<label for="g1exp">EXP</label>
										<input type="range" id="g1exp" value="0.005" min="0.00001" max=".01" step=".00001">
										<label for="g1coef">COEFF</label>
										<input type="range" id="g1coef" value="1" min=".01" max="2" step=".01" style="width: 50px;">
									</div>
									<div class="formant">
										<label for="g2freq">FREQ</label>
										<input type="range" id="g2freq" value="1300" min="1" max="8000" step="1">
										<label for="g2exp">EXP</label>
										<input type="range" id="g2exp" value="0.0025" min="0.00001" max=".01" step=".00001">
										<label for="g2coef">COEFF</label>
										<input type="range" id="g2coef" value="1" min=".01" max="2" step=".01" style="width: 50px;">
									</div>
									<div class="formant">
										<label for="g3freq">FREQ</label>
										<input type="range" id="g3freq" value="1900" min="1" max="8000" step="1">
										<label for="g3exp">EXP</label>
										<input type="range" id="g3exp" value="0.0015" min="0.00001" max=".01" step=".00001">
										<label for="g3coef">COEFF</label>
										<input type="range" id="g3coef" value="1" min=".01" max="2" step=".01" style="width: 50px;">
									</div>
									<div class="formant">
										<label for="g4freq">FREQ</label>
										<input type="range" id="g4freq" value="2200" min="1" max="8000" step="1">
										<label for="g4exp">EXP</label>
										<input type="range" id="g4exp" value="0.0005" min="0.00001" max=".01" step=".00001">
										<label for="g4coef">COEFF</label>
										<input type="range" id="g4coef" value="1" min=".01" max="2" step=".01" style="width: 50px;">
									</div>
									<div class="formant">
										<label for="g5freq">FREQ</label>
										<input type="range" id="g5freq" value="5100" min="1" max="8000" step="1">
										<label for="g5exp">EXP</label>
										<input type="range" id="g5exp" value="0.00015" min="0.00001" max=".01" step=".0001">
										<label for="g5coef">COEFF</label>
										<input type="range" id="g5coef" value="1" min=".01" max="2" step=".01" style="width: 50px;">
									</div>
								</div>
								<label for="wtgg_numHarmonics">Harmonics: </label>
								<input type="number" id="wtgg_numHarmonics" value="16" min="1" max="128" step="1" style="width: 50px;"> 
								<label for="wtgg_attenuatorPow">Attenatuor: </label>
								<input type="number" id="wtgg_attenuator" value="1" min=".01" max="3" step=".05" style="width: 50px;">
								<label for="wtgg_bandwith">Bandwith: </label>
								<input type="number" id="wtgg_bandwith" value="50" min="1" max="240" step="1" style="width: 50px;">
								<label for="wtgg_bandwithScale">Bw scale: </label>
								<input type="number" id="wtgg_bandwithScale" value="1" min="0.01" max="200" step="0.01" style="width: 50px;">
							</div>
							
						</div>
						
					</div>
				</div>

				<div style="background-color: rgba(10,10,10,0.8);  margin-bottom:5px; padding:6px; border-top:1px solid #333;">
					<div class="optTitle" style="border:none;">Instrument [3]</div>
					<div class="instrument" id="ins3">
						<div class="instOpt">
							<label for="hVolume">Volume: </label>
							<input type="range" value ="0.5" min="0" max="1" step="0.01" id="hVolume">
							<label for="hPan">Pan L/R:</label>
							<input type="range" value="0" min="-1" max="1" step="0.01" id="hPan" style="width: 50px;">
							<br/>
							<div class="expandTitle" onmousedown="toggleOptions(this)">Envelope: +</div>
							<div id="hEnvelope" style="display:none;">
								<label for="hAttack">Attack: </label>
								<input type="range" value ="0.01" min="0.01" max="1" step="0.01" id="hAttack" style="width: 50px;">
								<label for="hRelease">Release: </label>
								<input type="range" value ="0.4" min="0.01" max="1" step="0.01" id="hRelease" style="width: 50px;">
								<label for="hNLength">Note Length: </label>
								<input type="range" value ="0.7" min="0.01" max="1" step="0.01" id="hNLength" style="width: 50px;">
							</div>
						</div>
						<div class="instFx" style="border-bottom: 0px solid #444;">
							<div class="expandTitle" onmousedown="toggleOptions(this)"> Effects: +</div>
							<div id="hEffects" style="display:none;">
								<input type="checkbox" id="i3fx" checked> &nbsp;&nbsp;
								<label for="hDelayTime">Delay Time:</label>
								<input type="number" value="0.2" min="0" max="2" step="0.01" id="hDelayTime" style="width: 50px;"> 
								<label for="hDelayFeedback">Delay Feedback:</label>
								<input type="range" value="0.5" min="0" max="1" step="0.01" id="hDelayFeedback" style="width: 50px;">
								<label for="hDelayAmount">Delay Amount: </label>
								<input type="range" value="0.45" min="0" max="1" step="0.01" id="hDelayAmount" style="width: 50px;">
							</div>
						</div>
						<div class="instAdv"  onclick="updateInsts();" >
							<div class="inst-select">
								<input type="radio" name="ins3_sel"> Sine | 
								<input type="radio" name="ins3_sel"> Square |
								<input type="radio" name="ins3_sel" checked> Triangle |
								<input type="radio" name="ins3_sel"> Saw |
								<input type="radio" name="ins3_sel">
							</div>
							<div class="expandTitle" style="display: inline-block;border:none;" onmousedown="toggleOptions(this)">Wavetable from Harmonics: +</div>
							<div onclick="updateHH()" style="display:none;" class="epanel">
								<div class="wtHarmonic">
									<label for="h1amp">AMP </label>
									<input type="range" id="h1amp" value="1" min="0.0005" max="1" step=".0005">
									<label for="h1frm">FREQ*</label>
									<input type="range" id="h1frm" value="1" min="1" max="100" step="1">
									<label for="h1bw">Bandwith</label>
									<input type="range" id="h1bw" value="20" min="1" max="120" step=".1" style="width: 50px;">
								</div>
								<div class="wtHarmonic">
									<label for="h2amp">AMP </label>
									<input type="range" id="h2amp" value="0.65" min="0.0005" max="1" step=".0005">
									<label for="h2frm">FREQ*</label>
									<input type="range" id="h2frm" value="7" min="1" max="100" step="1">
									<label for="h2bw">Bandwith</label>
									<input type="range" id="h2bw" value="15" min="1" max="120" step=".1" style="width: 50px;">
								</div>
								<div class="wtHarmonic">
									<label for="h3amp">AMP </label>
									<input type="range" id="h3amp" value="0.425" min="0.0005" max="1" step=".0005">
									<label for="h3frm">FREQ*</label>
									<input type="range" id="h3frm" value="19" min="1" max="100" step="1">
									<label for="h3bw">Bandwith</label>
									<input type="range" id="h3bw" value="15" min="1" max="120" step=".1" style="width: 50px;">
								</div>
								<div class="wtHarmonic">
									<label for="h4amp">AMP </label>
									<input type="range" id="h4amp" value="0.1925" min="0.0005" max="1" step=".0005">
									<label for="h4frm">FREQ*</label>
									<input type="range" id="h4frm" value="21" min="1" max="100" step="1">
									<label for="h4bw">Bandwith</label>
									<input type="range" id="h4bw" value="15" min="1" max="120" step=".1" style="width: 50px;">
								</div>
								<div class="wtHarmonic">
									<label for="h5amp">AMP </label>
									<input type="range" id="h5amp" value="0.075" min="0.0005" max="1" step=".00005">
									<label for="h5frm">FREQ*</label>
									<input type="range" id="h5frm" value="39" min="1" max="100" step="1">
									<label for="h5bw">Bandwith</label>
									<input type="range" id="h5bw" value="15" min="1" max="120" step=".1" style="width: 50px;">
								</div>
								<label for="wthh_numHarmonics">Harmonics: </label>
								<input type="number" id="wthh_numHarmonics" value="1" min="1" max="4" step="1" style="width: 50px;">
							</div>
						</div>
						
					</div>
				</div>

				<div style="background-color: rgba(15,25,25,0.6);  margin-bottom:5px; padding:6px; border-top:1px solid #333;">
					<div class="optTitle" style="border:none;">Instrument [4]</div>
					<div class="instrument" id="ins3">
					<div class="instOpt">
						<label for="jVolume">Volume: </label>
						<input type="range" value ="0.1" min="0" max="1" step="0.01" id="jVolume">
						<label for="jPan">Pan L/R:</label>
						<input type="range" value="0" min="-1" max="1" step="0.01" id="jPan" style="width: 50px;">
						<br/>
						<div class="expandTitle" onmousedown="toggleOptions(this)">Envelope: +</div>
						<div id="jEnvelope" style="display:none;">
							<label for="jAttack">Attack: </label>
							<input type="range" value ="0.1" min="0.01" max="1" step="0.01" id="jAttack" style="width: 50px;">
							<label for="jRelease">Release: </label>
							<input type="range" value ="0.1" min="0.01" max="1" step="0.01" id="jRelease" style="width: 50px;">
							<label for="jNLength">Note Length: </label>
							<input type="range" value ="0.1" min="0.01" max="1" step="0.01" id="jNLength" style="width: 50px;">
						</div>
					</div>
					<div class="instFx" style="border-bottom: 0px solid #444;">
						<div class="expandTitle" onmousedown="toggleOptions(this)"> Effects: +</div>
						<div id="jEffects" style="display:none;">
							<input type="checkbox" id="i4fx" checked> &nbsp;&nbsp;
							<label for="jDelayTime">Delay Time:</label>
							<input type="number" value="0.1" min="0" max="2" step="0.01" id="jDelayTime" style="width: 50px;"> 
							<label for="jDelayFeedback">Delay Feedback:</label>
							<input type="range" value="0.2" min="0" max="1" step="0.01" id="jDelayFeedback" style="width: 50px;">
							<label for="jDelayAmount">Delay Amount: </label>
							<input type="range" value="0.2" min="0" max="1" step="0.01" id="jDelayAmount" style="width: 50px;">
						</div>
					</div>
					<div class="instAdv"  >
						<div class="inst-select"  onclick="updateInsts();">
							<input type="radio" name="ins4_sel"> Sine | 
							<input type="radio" name="ins4_sel"> Square |
							<input type="radio" name="ins4_sel"> Triangle |
							<input type="radio" name="ins4_sel"> Saw |
							<input type="radio" name="ins4_sel" checked>
						</div>
						<div class="expandTitle" style="display: inline-block; border:none;" onmousedown="toggleOptions(this)"> Wavetable from Harmonics: +</div>
						<div onclick="updateJJ()" style="display:none;" class="epanel">
							<div class="wtHarmonic">
								<label for="j1amp">AMP </label>
								<input type="range" id="j1amp" value="1" min="0.0005" max="1" step=".0005">
								<label for="j1frm">FREQ*</label>
								<input type="range" id="j1frm" value="1" min="1" max="100" step="1">
								<label for="j1bw">Bandwith</label>
								<input type="range" id="j1bw" value="20" min="1" max="120" step=".1" style="width: 50px;">
							</div>
							<div class="wtHarmonic">
								<label for="j2amp">AMP </label>
								<input type="range" id="j2amp" value="0.5" min="0.0005" max="1" step=".0005">
								<label for="j2frm">FREQ*</label>
								<input type="range" id="j2frm" value="4" min="1" max="100" step="1">
								<label for="j2bw">Bandwith</label>
								<input type="range" id="j2bw" value="15" min="1" max="120" step=".1" style="width: 50px;">
							</div>
							<div class="wtHarmonic">
								<label for="j3amp">AMP </label>
								<input type="range" id="j3amp" value="0.25" min="0.0005" max="1" step=".0005">
								<label for="j3frm">FREQ*</label>
								<input type="range" id="j3frm" value="8" min="1" max="100" step="1">
								<label for="j3bw">Bandwith</label>
								<input type="range" id="j3bw" value="15" min="1" max="120" step=".1" style="width: 50px;">
							</div>
							<div class="wtHarmonic">
								<label for="j4amp">AMP </label>
								<input type="range" id="j4amp" value="0.125" min="0.0005" max="1" step=".0005">
								<label for="j4frm">FREQ*</label>
								<input type="range" id="j4frm" value="16" min="1" max="100" step="1">
								<label for="j4bw">Bandwith</label>
								<input type="range" id="j4bw" value="15" min="1" max="120" step=".1" style="width: 50px;">
							</div>
							<div class="wtHarmonic">
								<label for="j5amp">AMP </label>
								<input type="range" id="j5amp" value="0.0625" min="0.0005" max="1" step=".00005">
								<label for="j5frm">FREQ9</label>
								<input type="range" id="j5frm" value="32" min="1" max="100" step="1">
								<label for="j5bw">Bandwith</label>
								<input type="range" id="j5bw" value="15" min="1" max="120" step=".1" style="width: 50px;">
							</div>
							<label for="wtjj_numHarmonics">Harmonics: </label>
							<input type="number" id="wtjj_numHarmonics" value="2" min="1" max="4" step="1" style="width: 50px;"> 
						</div>

					</div>
					
					</div>
				</div>

			</div>
		</div>
    </div>
</body>
<script id="vshader" type="">#version 300 es
	in vec3 position;
	out vec2 uv;
	void main(void) {
		gl_Position = vec4(position, 1.0);
		uv = position.xy;
	}
</script>
	
<script id="fshader" type="">#version 300 es
precision highp float;

in vec2 uv;

uniform vec2 g_resolution;
uniform vec3 g_camUp;
uniform vec3 g_camRight;
uniform vec3 g_camForward;
uniform vec3 g_eye;

uniform float u_Time;

uniform vec3 g_light0Position;
uniform vec4 g_light0Color;
uniform vec3 lightNote;

uniform bool medium;
uniform bool antiAlias;
uniform float normalSmooth;

uniform float clipNear;
uniform float clipFar;
uniform float focalLength;
uniform int rmSteps;
uniform float surfThres;

uniform float addX;
uniform float addY;
uniform float addZ;
uniform bool addC;

uniform int iter;
uniform bool repeatFractal;
uniform float repeatDistance;

uniform int colorOpt;
uniform float mainLightInt;
uniform float clickLightInt;
uniform float clickLightSize;
uniform vec3 solidColor;

uniform bool aoswitch;

const vec4 g_skyColor = vec4(0.0, 0.0, 0.0, 0.0);
const vec4 g_ambient = vec4(1.0, 1.0, 1.0, 1.0);
//const vec4 g_ambient = vec4(0.);

/*float fade(float t){
	return t*t*t*(t*(t*6.0-15.0)+10.0);
	//return 0.5 - sin(asin(1.0 - 2.0 * t) / 3.0);//inverse smooth
}*/

/*vec2 cx_sqr(vec2 a) {
	float x2 = a.x*a.x; float y2 = a.y*a.y; float xy = a.x*a.y;
	return vec2(x2 - y2, xy + xy);
}*/

//vec2 mandelbrot(vec2 z, vec2 c) { return cx_sqr(z) + c; }

float mapTo(float x, float minX, float maxX, float minY, float maxY){
	float a = (maxY - minY) / (maxX - minX);
	float b = minY - a * minX;
	return a * x + b;
}

//float udBox(vec3 p, vec3 size){return length(max(abs(p) - size, vec3(0.0)));}

float menger(vec3 z, vec3 pG){
	float mx, my, mz, tr;
	//vec3 temp = z;

	for(int i = 0 ; i<iter; i++){
		//z.x = abs(z.x)+( sin(u_Time+pG.x)-3.5 )*.5;
		//z.y = abs(z.y)+( sin(u_Time+pG.y)-2.5 )*.5;
		//z.z = abs(z.z)+( sin(u_Time+pG.z)-1.5 )*.5;

		z.x = abs(z.x)+( (addC?sin(.5+pG.x):0.)+addX )*.5;
		z.y = abs(z.y)+( (addC?sin(.5+pG.y):0.)+addY )*.5;
		z.z = abs(z.z)+( (addC?sin(.5+pG.z):0.)+addZ )*.5;
		
		if (z.x - z.y < 0.0) {
			mx = z.x;
			my = z.y;
			z.x = my;
			z.y = mx;
			//swap(z.x, z.y)
		};
		if (z.x - z.z < 0.0) {
			mx = z.x;
			mz = z.z;
			z.x = mz;
			z.z = mx;
			//swap(z.x, z.z)
		};
		if (z.y - z.z < 0.0) {
			my = z.y;
			mz = z.z;
			z.y = mz;
			z.z = my;
			//swap(z.y, z.z)
		};

		z *= 3.0;
		z.x -= 2.0;
		z.y -= 2.0;
		if (z.z > 1.0) z.z -= 2.0;
		
	}
	return (length(z)*.000001);
}

/*float sdBox(vec3 p, vec3 size){ vec3 d = abs(p) - size; return min(max(d.x, max(d.y, d.z)), 0.0) + udBox(p, size); }
float sdSphere(vec3 p, float radius){ return length(p) - radius; }
*/

float distScene(vec3 p){
	vec3 pGlobal = p;
	if(repeatFractal){
		p.xyz = mod(p.xyz, repeatDistance*2.)-vec3(repeatDistance);
	}
	return menger(p, pGlobal);
}

vec3 getNormal(vec3 p){
	float h = normalSmooth;
	return normalize(vec3(
		distScene(p + vec3(h, 0, 0)) - distScene(p - vec3(h, 0, 0)),
		distScene(p + vec3(0, h, 0)) - distScene(p - vec3(0, h, 0)),
		distScene(p + vec3(0, 0, h)) - distScene(p - vec3(0, 0, h))));
}

float getShadow(vec3 p0, vec3 p1, float k){
	vec3 rd = normalize(p1 - p0);
	float t = 10.0 * surfThres;
	float maxt = length(p1 - p0);
	float f = 1.0;
	for(int i = 0; i < rmSteps; ++i){
		float d = distScene(p0 + rd * t);
		if(d < surfThres)
			return 0.0;
		// See http://www.iquilezles.org/www/articles/rmshadows/rmshadows.htm
		f = min(f, k * d / t);
		t += d;
		if(t >= maxt)
			break;
	}
	return f;
}

vec4 getShadingT(vec3 p, vec3 normal, vec3 lightPos, vec4 lightColor, float t){
	vec3 lightP = lightPos;
	lightP += normal*t;
	float lightIntensity = 0.0;
	float shadow = getShadow(p, lightP, 2.0);
	if(shadow > 0.0)
	{
		vec3 lightDirection = normalize(lightP - p);
		lightIntensity = shadow * clamp(dot(normal, lightDirection), 0.0, 1.0);
	}
	return lightColor * lightIntensity + g_ambient * (1.0 - lightIntensity);
}

void raymarch(vec3 ro, vec3 rd, out int i, out float t){
	t = 0.0;
	for(int j = 0; j < rmSteps; ++j){
		vec3 p = ro + ( rd * t );
		float d = distScene(p);
		if(d < surfThres*t*30. || t > clipFar){
			i = j;
			break;
		}
		t += d;
	}
}

float ambientOcclusion(vec3 p, vec3 n){
	float stepSize = 0.015;
	float t = stepSize;
	float oc = 0.0;
	for(int i = 0; i < 10; ++i){
		float d = distScene(p + n * t);
		oc += t - d;
		t += stepSize;
	}
	return clamp(oc, 0.0, 1.0);
}

vec4 computeColor(vec3 ro, vec3 rd){
	float t0;
	int i;
	raymarch(ro, rd, i, t0);

	vec3 p;
	vec3 normal;
	float t;

	if(i < rmSteps && t0 >= clipNear && t0 <= clipFar){
		t = t0;
		p = ro + rd * t0;
		normal = getNormal(p);
	}else{
		return g_skyColor;
	}

	vec4 color;
	vec4 texture = vec4(1.0);

	color = texture * (
		getShadingT(p, normal, g_light0Position, vec4(1.0)*mainLightInt, 0.) +
		getShadingT(p, normal, lightNote, g_light0Color*clickLightInt, t*clickLightSize)
		) / 10.0;

	switch (colorOpt) {
		case 0:
			color *= vec4(abs(normal), 1.0);
			break;
		case 1:
			color *= vec4( vec3(1.-t*.05), 1.0);
			break;
		case 2:
			color *= vec4( solidColor, 1.0);
			break;
		default:
			break;
	}

	if(aoswitch){
		float ao = ambientOcclusion(p, normal);
		color *= vec4(1.0 - ao);
	}	

	float z = mapTo(t, clipNear, clipFar, 1.0, 0.0);
	float zSqrd = z * z * z;
	color = mix(g_skyColor, color, zSqrd * (3.0 - 2.0 * z)); // Fog

	return color;
}


vec4 computeDistOnly(vec3 ro, vec3 rd){
	float t0;
	int i;
	raymarch(ro, rd, i, t0);

	vec3 p;
	vec3 normal;
	float t;

	if(i < rmSteps && t0 >= clipNear && t0 <= clipFar){
		t = t0;
		p = ro + rd * t0;
		normal = getNormal(p);
	}else{
		return vec4(0.0);
	}

	vec4 color;
	color = vec4(p,t);

	return color;
}

out vec4 fragColor;
void main(void) {
	float aspectRatio = g_resolution.x / g_resolution.y;
	vec3 ro = g_eye;
	vec3 rd = normalize(g_camForward * focalLength + g_camRight * uv.x * aspectRatio + g_camUp * uv.y);
	if(antiAlias&&medium){
		vec2 hps = vec2(1.0) / (g_resolution * 2.);
		vec3 rd0 = normalize(g_camForward * focalLength + g_camRight * (uv.x - hps.x) * aspectRatio + g_camUp * uv.y);
		vec3 rd1 = normalize(g_camForward * focalLength + g_camRight * (uv.x + hps.x) * aspectRatio + g_camUp * uv.y);
		vec3 rd2 = normalize(g_camForward * focalLength + g_camRight * uv.x * aspectRatio + g_camUp * (uv.y - hps.y));
		vec3 rd3 = normalize(g_camForward * focalLength + g_camRight * uv.x * aspectRatio + g_camUp * (uv.y + hps.y));
		fragColor = (computeColor(ro, rd0) + computeColor(ro, rd1) + computeColor(ro, rd2) + computeColor(ro, rd3)) / 4.0;
	} else {
		vec4 color = medium?computeColor(ro, rd):computeDistOnly(ro, rd);
		fragColor = medium?vec4(color.xyz, 0.0):vec4(color);
	}
}

</script>
<script>

const noteColor = [
		document.getElementById('notemark-r'),
		document.getElementById('notemark-g'),
		document.getElementById('notemark-b'),
		document.getElementById('notemark-d')
	];

let mm = 8;
document.getElementById('modpoint').addEventListener('input', function () {
        mm = this.value;
    });

function updateCompass(){
	let noteObj = [
		{mark:noteColor[0],note:datapitch[0],octave:1},
		{mark:noteColor[1],note:datapitch[1],octave:1},
		{mark:noteColor[2],note:datapitch[2],octave:1},
		{mark:noteColor[3],note:datapitch[3],octave:1},
	];

	noteObj.sort(function(a, b){return a.note - b.note}); 

	let n1 = 1;
	let n2 = noteObj[1].note/noteObj[0].note;
	let n3 = noteObj[2].note/noteObj[0].note;
	let n4 = noteObj[3].note/noteObj[0].note;

	function getClosedOctave() {
        let set = [n1,n2,n3,n4];
		
        for (let c = 0; c < set.length; c++) {
            if (set[c] > 2) {
                while (set[c] > 2) {
                    set[c] /= 2;
                }
            }
            else if (set[c] < 1) {
                while (set[c] < 1) {
                    set[c] *= 2;
                }
            }
			noteObj[c].octave = set[c];
        }
        return set;
    }

	getClosedOctave();
	noteObj[0].mark.style.top = "50px";
	noteObj[1].mark.style.top = "60px";
	noteObj[2].mark.style.top = "70px";
	noteObj[3].mark.style.top = "80px";

	noteObj[0].mark.style.transformOrigin = "0px 0px 0";
	noteObj[1].mark.style.transformOrigin = "0px -10px 0";
	noteObj[2].mark.style.transformOrigin = "0px -20px 0";
	noteObj[3].mark.style.transformOrigin = "0px -30px 0";

	noteObj[0].mark.style.transform = "rotate(" + ( Math.log2(noteObj[0].octave) *360) + "deg)";
	noteObj[1].mark.style.transform = "rotate(" + ( Math.log2(noteObj[1].octave) *360) + "deg)";
	noteObj[2].mark.style.transform = "rotate(" + ( Math.log2(noteObj[2].octave) *360) + "deg)";
	noteObj[3].mark.style.transform = "rotate(" + ( Math.log2(noteObj[3].octave) *360) + "deg)";
}

function GetTrueOne(rname){
    var options = document.getElementsByName(rname);
    var t;
    for (t=0; t < options.length ; t++){
        if(options[t].checked==true){
            return t;
        }
    }
}

var sliders=document.querySelectorAll('input[type="range"');
for(let i = 0;i<sliders.length; i++){
	var valc = document.createElement('div');
	valc.className ="rangeValue";
	valc.innerHTML = sliders[i].value;
	sliders[i].oninput = ()=>{updateSlider(sliders[i])};
	sliders[i].previousElementSibling.insertAdjacentElement("afterend", valc);
}

function updateSlider(s){
	s.previousElementSibling.innerHTML = s.value;
}

function toggleOptions(el){
	var cosa = el.nextElementSibling;
	if(cosa.style.display=="block"){
		cosa.style.display = "none";
	}else{
		cosa.style.display= "block";
	}
}

let gl = null;

function getShader(gl, id) {
	var script = document.getElementById(id);
	if(!script) {
		return null;
	}
	var src = "";
	var k = script.firstChild;
	while(k) {
		if(k.nodeType == 3) {
			src += k.textContent;
		}
		k = k.nextSibling;
	}
	var shader;
	if(script.id == "fshader") {
		shader = gl.createShader(gl.FRAGMENT_SHADER);
	} else if(script.id == "vshader") {
		shader = gl.createShader(gl.VERTEX_SHADER);
	} else {
		return null;
	}
	gl.shaderSource(shader, src);
	gl.compileShader(shader);
	if(!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
		alert(gl.getShaderInfoLog(shader));
		return null;
	}
	return shader;
}

var program;
var vbo;
function initProgram() {
	var fragmentShader = getShader(gl, "fshader");
	var vertexShader = getShader(gl, "vshader");

	program = gl.createProgram();
	gl.attachShader(program, vertexShader);
	gl.attachShader(program, fragmentShader);
	gl.linkProgram(program);

	if(!gl.getProgramParameter(program, gl.LINK_STATUS)) {
		alert("Unable to initialize the shader program");
	}

    var ext_color_buffer_float = gl.getExtension("EXT_color_buffer_float");
	gl.useProgram(program);

	var quad = [
		-1.0, -1.0, 0.0,
		-1.0,  1.0, 0.0,
		 1.0, -1.0, 0.0,
		 1.0,  1.0, 0.0
	];

	vbo = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, vbo);
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(quad), gl.STATIC_DRAW);

	program.positionAttrib = gl.getAttribLocation(program, "position");
	gl.enableVertexAttribArray(program.positionAttrib);
	gl.vertexAttribPointer(program.positionAttrib, 3, gl.FLOAT, false, 0, 0);

	program.resolutionUniform = gl.getUniformLocation(program, "g_resolution");

	program.u_Time = gl.getUniformLocation(program, "u_Time");
	program.camUpUniform = gl.getUniformLocation(program, "g_camUp");
	program.camRightUniform = gl.getUniformLocation(program, "g_camRight");
	program.camForwardUniform = gl.getUniformLocation(program, "g_camForward");
	program.eyeUniform = gl.getUniformLocation(program, "g_eye");
	program.light0PositionUniform = gl.getUniformLocation(program, "g_light0Position");
	program.light0ColorUniform = gl.getUniformLocation(program, "g_light0Color");

	program.lightNote = gl.getUniformLocation(program, "lightNote");
	program.medium = gl.getUniformLocation(program, "medium");

	program.normalSmooth = gl.getUniformLocation(program, "normalSmooth");

	program.antiAlias = gl.getUniformLocation(program, "antiAlias");

	program.clipNear = gl.getUniformLocation(program, "clipNear");
	program.clipFar = gl.getUniformLocation(program, "clipFar");
	program.focalLength = gl.getUniformLocation(program, "focalLength");
	program.rmSteps = gl.getUniformLocation(program, "rmSteps");
	program.surfThres = gl.getUniformLocation(program, "surfThres");

	program.iter = gl.getUniformLocation(program, "iter");

	program.addX = gl.getUniformLocation(program, "addX");
	program.addY = gl.getUniformLocation(program, "addY");
	program.addZ = gl.getUniformLocation(program, "addZ");
	program.addC = gl.getUniformLocation(program, "addC");

	program.repeatFractal = gl.getUniformLocation(program, "repeatFractal");
	program.repeatDistance = gl.getUniformLocation(program, "repeatDistance");

	program.colorOpt = gl.getUniformLocation(program, "colorOpt");
	program.mainLightInt = gl.getUniformLocation(program, "mainLightInt");
	program.clickLightInt = gl.getUniformLocation(program, "clickLightInt");
	program.clickLightSize = gl.getUniformLocation(program, "clickLightSize");
	program.solidColor = gl.getUniformLocation(program, "solidColor");

	program.aoswitch = gl.getUniformLocation(program, "aoswitch");
}

var g_eye;
var g_camUp;
var g_camRight;
var g_camForward;
var g_light0Position = [0, 4, 0];
var g_light0Color = [1.0, 1.0, 1.0, 1.0];
var horizontalAngle = 0.0;
var verticalAngle = 0.0;

function initCamera() {
	horizontalAngle = 0.0;
	verticalAngle = 0.0;
	g_eye = [0, 0,-6];
	g_camUp = [0, 1, 0];
	g_camRight = [0, 0, 1];
	g_camForward = vec3.create();
	vec3.cross(g_camForward, g_camRight, g_camUp);
	vec3.normalize(g_camForward, g_camForward);
}

var mouseSpeedX = null;
var mouseSpeedY = null;

function handleMouseMove(event) {
	if(document.getElementById("pan-mouse").checked){
		let speed = document.getElementById("mouse-speed").value;
		var mouseX = event.clientX;
		var mouseY = event.clientY;
		var rect = document.getElementById("glcanvas").getBoundingClientRect();
		var dx = mouseX - (rect.left + rect.width / 2);
		var dy = mouseY - (rect.top + rect.height / 2);
		mouseSpeedX = dx * 0.00005 * speed ;
		mouseSpeedY = dy * 0.00005 * speed ;
	}
	else{
		mouseSpeedX = null;
		mouseSpeedY = null;
	}
	
}

var currentKeys = {};
function handleKeyDown(event) {
	currentKeys[event.keyCode] = true;
}
function handleKeyUp(event) {
	currentKeys[event.keyCode] = false;
	if(event.keyCode==16){
		toggleChecked("key-wasd");
	}
	if(event.keyCode==17){
		toggleChecked("pan-mouse");
	}
}

function toggleChecked(ch){
	let tt = document.getElementById(ch).checked;
	if(tt){
		document.getElementById(ch).checked = false;
	}
	else if(!tt){
		document.getElementById(ch).checked = true;
	}
}

function handleInput() {
	if(document.getElementById("key-wasd").checked){
		var moveSpeed = 0.05 * document.getElementById("key-speed").value;
		if(currentKeys[38]) { // Forward
			g_eye[0] += g_camForward[0] * moveSpeed;
			g_eye[1] += g_camForward[1] * moveSpeed;
			g_eye[2] += g_camForward[2] * moveSpeed;
		} else if(currentKeys[40]) { // Backward
			g_eye[0] -= g_camForward[0] * moveSpeed;
			g_eye[1] -= g_camForward[1] * moveSpeed;
			g_eye[2] -= g_camForward[2] * moveSpeed;
		}
		if(currentKeys[39]) { // Right
			g_eye[0] += g_camRight[0] * moveSpeed;
			g_eye[1] += g_camRight[1] * moveSpeed;
			g_eye[2] += g_camRight[2] * moveSpeed;
		} else if(currentKeys[37]) { // Left
			g_eye[0] -= g_camRight[0] * moveSpeed;
			g_eye[1] -= g_camRight[1] * moveSpeed;
			g_eye[2] -= g_camRight[2] * moveSpeed;
		}
	}
}

function setCamera() {
	horizontalAngle += mouseSpeedX;
	verticalAngle += mouseSpeedY;

	if(horizontalAngle > 2.0 * Math.PI)
		horizontalAngle -= 2.0 * Math.PI;
	else if(horizontalAngle < 0.0)
		horizontalAngle += 2.0 * Math.PI;

	if(verticalAngle > 2.0 * Math.PI)
		verticalAngle -= 2.0 * Math.PI;
	else if(verticalAngle < 0.0)
		verticalAngle += 2.0 * Math.PI;

	var sintheta = Math.sin(horizontalAngle);
	var costheta = Math.cos(horizontalAngle);
	var sinphi = Math.sin(verticalAngle);
	var cosphi = Math.cos(verticalAngle);
	g_camForward = [cosphi * sintheta, -sinphi, cosphi * costheta];
	g_camRight = [costheta, 0.0, -sintheta];
	vec3.cross(g_camUp, g_camForward, g_camRight);
	vec3.normalize(g_camUp, g_camUp);
}

function setUniforms() {
	gl.uniform1f(program.addX, document.getElementById('addX').value);
	gl.uniform1f(program.addY, document.getElementById('addY').value);
	gl.uniform1f(program.addZ, document.getElementById('addZ').value);

	gl.uniform1i(program.addC, document.getElementById('addC').checked);

	gl.uniform1f(program.repeatDistance, document.getElementById('repeatDistance').value);
	gl.uniform1i(program.repeatFractal, document.getElementById('repeatFractal').checked);

	gl.uniform1i(program.antiAlias, document.getElementById('antiAlias').checked);
	gl.uniform1i(program.iter, document.getElementById('iter').value);
	gl.uniform1f(program.normalSmooth, document.getElementById('normalSmooth').value);

	gl.uniform1f(program.clipNear, document.getElementById('clip-near').value);
	gl.uniform1f(program.clipFar, document.getElementById('clip-far').value);
	gl.uniform1f(program.focalLength, document.getElementById('focal-length').value);

	gl.uniform1i(program.rmSteps, document.getElementById('rm-steps').value);
	gl.uniform1f(program.surfThres, document.getElementById('surf-thres').value);

	gl.uniform2f(program.resolutionUniform, gl.viewportWidth, gl.viewportHeight);
	gl.uniform1f(program.u_Time, tTime);
	gl.uniform3f(program.camUpUniform, g_camUp[0], g_camUp[1], g_camUp[2]);
	gl.uniform3f(program.camRightUniform, g_camRight[0], g_camRight[1], g_camRight[2]);
	gl.uniform3f(program.camForwardUniform, g_camForward[0], g_camForward[1], g_camForward[2]);
	gl.uniform3f(program.eyeUniform, g_eye[0], g_eye[1], g_eye[2]);

	gl.uniform3f(program.light0PositionUniform, g_eye[0], g_eye[1], g_eye[2]);
	
	gl.uniform4f(program.light0ColorUniform, g_light0Color[0], g_light0Color[1], g_light0Color[2], g_light0Color[3]);

	gl.uniform1f(program.mainLightInt, document.getElementById('mainLightInt').value);
	gl.uniform1f(program.clickLightInt, document.getElementById('clickLightInt').value);
	gl.uniform1f(program.clickLightSize, document.getElementById('clickLightSize').value);

	gl.uniform3f(program.solidColor, document.getElementById('color-r').value,
									document.getElementById('color-g').value,
									document.getElementById('color-b').value);

	gl.uniform1i(program.colorOpt, GetTrueOne('colorOpt'));

	gl.uniform1i(program.aoswitch, document.getElementById('aoswitch').checked);
}

let datanull = [1000,1000,1000,0];
let datapitch = [0,0,0,0];
let lightposx = 1000.;
let lightposy = 0.;
let lightposz = 0.;

const uiOF = [document.getElementById('posx_o'),
			document.getElementById('posy_o'),
			document.getElementById('posz_o'),
			document.getElementById('posd_o'),

			document.getElementById('posx_f'),
			document.getElementById('posy_f'),
			document.getElementById('posz_f'),
			document.getElementById('posd_f')
];

function updateUIValues(){
		uiOF[0].innerHTML = "X: "+Math.floor(datanull[0]*10000)/10000;
		uiOF[1].innerHTML = "Y: "+Math.floor(datanull[1]*10000)/10000;
		uiOF[2].innerHTML = "Z: "+Math.floor(datanull[2]*10000)/10000;
        uiOF[3].innerHTML = "D: "+Math.floor(datanull[3]*10000)/10000;

		uiOF[4].innerHTML = "X: "+Math.floor( datapitch[0]*ff *10000)/10000;
		uiOF[5].innerHTML = "Y: "+Math.floor( datapitch[1]*ff *10000)/10000;
		uiOF[6].innerHTML = "Z: "+Math.floor( datapitch[2]*ff *10000)/10000;
        uiOF[7].innerHTML = "D: "+Math.floor( datapitch[3]*ff *10000)/10000;
}

let scaleMode = GetTrueOne('scaleMode');
document.getElementById('scaleMode').addEventListener('input', function(){
	scaleMode = GetTrueOne('scaleMode');
});

let ff = 100;
document.getElementById('pointMult').addEventListener('input', function(){
	ff = document.getElementById('pointMult').value;
});

function updateDataPitch(){
	let d0,d1,d2,d3;
	if(datanull[0]!=0){

		switch (scaleMode) {
			case 0:
				d0 = Math.abs(datanull[0]); d1 = Math.abs(datanull[1]); d2 = Math.abs(datanull[2]); d3 = Math.abs(datanull[3]);
				break;

			case 1:
				d0 = Math.pow(2,Math.abs(datanull[0]));
				d1 = Math.pow(2,Math.abs(datanull[1]));
				d2 = Math.pow(2,Math.abs(datanull[2]));
				d3 = Math.pow(2,Math.abs(datanull[3]));
				break;

			default:
				break;
		}
		datapitch[0] = (d0%mm);
		datapitch[1] = (d1%mm);
		datapitch[2] = (d2%mm);
		datapitch[3] = (d3%mm);
	}
	else{
		datapitch=[0,0,0,0];
	}
}

var wclick;
document.body.onkeydown = playKeyboard;

function render(canvas) {
	canvas.onmousemove = readPixel;
	canvas.onmousedown = evPlay;

    let cw = canvas.width;
    let ch = canvas.height;
	gl.clear(gl.COLOR_BUFFER_BIT);

	handleInput();
	setCamera();
	setUniforms();
    //DRAW TO FLOAT 32 TEXTURE, BETTER RESOLUTION FOR THE SCALE
	var x, y;
	function readPixel(e){
		e = e || window.event;
        e.preventDefault();
		
		x = Clamp(0,512,(e.clientX - canvas.offsetLeft-274));
		y = 512-Clamp(0,512,(e.clientY - canvas.offsetTop-18));

		var texOut = gl.createTexture();
		gl.activeTexture(gl.TEXTURE0);
		gl.bindTexture(gl.TEXTURE_2D, texOut);
		//gl.texStorage2D(gl.TEXTURE_2D, 2, gl.RGBA32F, canvas.width, canvas.height);
		gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA32F, cw, ch, 0, gl.RGBA, gl.FLOAT, null);

		var fbOut = gl.createFramebuffer();
		gl.bindFramebuffer(gl.FRAMEBUFFER, fbOut);
		gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texOut, 0);

		gl.uniform1i(program.medium, false);
		gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
		//gl.bindFramebuffer(gl.FRAMEBUFFER, null);
		gl.readBuffer(gl.COLOR_ATTACHMENT0);
		datanull = new Float32Array(1*1*4);
		gl.readPixels(x,y,1,1,gl.RGBA,gl.FLOAT,datanull);

		updateDataPitch();
		updateUIValues();
		updateCompass();
	}
	
	function evPlay(e){
		e = e || window.event;
		wclick = e.button;
        e.preventDefault();
		canvas.onmouseup = exitDrag;
		canvas.onmousemove = bDrag;
		
		x = Clamp(0,512,(e.clientX - canvas.offsetLeft-274));
		y = 512-Clamp(0,512,(e.clientY - canvas.offsetTop-18));
		playt(x,y);		
	}

	function bDrag(e){
		e = e || window.event;
		e.preventDefault();

		x = Clamp(0,512,(e.clientX - canvas.offsetLeft-274));
		y = 512-Clamp(0,512,(e.clientY - canvas.offsetTop-18));
		playt(x,y);
    }

	function exitDrag(){
		canvas.onmouseup = null;
        canvas.onmousemove = readPixel;
	}
	
	function playt(x,y){

		var texOut = gl.createTexture();
		gl.activeTexture(gl.TEXTURE0);
		gl.bindTexture(gl.TEXTURE_2D, texOut);
		//gl.texStorage2D(gl.TEXTURE_2D, 2, gl.RGBA32F, canvas.width, canvas.height);
		gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA32F, cw, ch, 0, gl.RGBA, gl.FLOAT, null);

		var fbOut = gl.createFramebuffer();
		gl.bindFramebuffer(gl.FRAMEBUFFER, fbOut);
		gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texOut, 0);

		gl.uniform1i(program.medium, false);
		gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
		//gl.bindFramebuffer(gl.FRAMEBUFFER, null);
		gl.readBuffer(gl.COLOR_ATTACHMENT0);
		datanull = new Float32Array(1*1*4);
		gl.readPixels(x,y,1,1,gl.RGBA,gl.FLOAT,datanull);
		
        if(datanull[0]==0){
            datanull[0]=1000.;//LIGHT GOES AWAY
            datanull[1]=1000.;
            datanull[2]=1000.;
            //and plays nothing, because wev clicked beyond clipping 
        }else{
            lightposx = datanull[0];
            lightposy = datanull[1];
            lightposz = datanull[2];

            currentPitches[0]=datapitch[0]*ff;
            currentPitches[1]=datapitch[1]*ff;
            currentPitches[2]=datapitch[2]*ff;
            currentPitches[3]=datapitch[3]*ff;

            let toPlay = wclick==0?playclick0:playclick1;
            for(p = 0; p<4;p++){
                if(toPlay[p]){
                    playTone(currentPitches[p],wclick);
                }
            }              
            updateDataPitch();
            updateUIValues();
            updateCompass();
        }
	}

	//DRAW TO SCREEN
	gl.uniform1i(program.medium, true);
	gl.uniform3f(program.lightNote, lightposx,lightposy,lightposz)

	gl.bindFramebuffer(gl.FRAMEBUFFER, null);
	gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
}

let playclick0 = [false,false,false,false];
let playclick1 = [false,false,false,false];
function updatePlayClicks(){
	playclick0 = [document.getElementById('lc_playx').checked,
					document.getElementById('lc_playy').checked,
					document.getElementById('lc_playz').checked,
					document.getElementById('lc_playd').checked];

	playclick1 = [document.getElementById('mc_playx').checked,
					document.getElementById('mc_playy').checked,
					document.getElementById('mc_playz').checked,
					document.getElementById('mc_playd').checked];
}
updatePlayClicks();
const currentPitches = [];

function lightUI(w){
	let ui;
	switch (w) {
		case "x":
			ui = document.getElementById('playing_x');
			ui.style.backgroundColor = "red";
			setTimeout(lightoffUI, 100, ui);
			break;
		case "y":
			ui = document.getElementById('playing_y');
			ui.style.backgroundColor = "green";
			setTimeout(lightoffUI, 100, ui);
			break;
		case "z":
			ui = document.getElementById('playing_z');
			ui.style.backgroundColor = "blue";
			setTimeout(lightoffUI, 100, ui);
			break;
		case "d":
			ui = document.getElementById('playing_d');
			ui.style.backgroundColor = "gray";
			setTimeout(lightoffUI, 100, ui);
			break;
	
		default:
			break;
	}
	function lightoffUI(u){
		u.style.backgroundColor = "transparent";
	}
}

var tTime = 0;
function tick(canvas) {
	requestAnimFrame(tick);
	if(document.getElementById('renderONOFF').checked){
		render(canvas);
	//tTime += .005;
	}
}

function start() {
	var canvas = document.getElementById("glcanvas");
	if(!window.WebGLRenderingContext) {
		alert("NO WEBGL")
	}
	try { gl = canvas.getContext("webgl2"); } 
	catch(e) { }

	if(gl){
		gl.viewportWidth = canvas.width;
		gl.viewportHeight = canvas.height;

		initProgram();
		initCamera();

		gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
		gl.clearColor(0.3, 0.3, 0.3, 1);
		
		document.onmousemove = handleMouseMove;
		document.onkeydown = handleKeyDown;
		document.onkeyup = handleKeyUp;

		tick(canvas);
	}
}

function Clamp(min,max,clamped){
    if(clamped<min){clamped=min;}
    if(clamped>max){clamped=max;}
    return clamped;
}

let ckey = null;
function playKeyboard(e) {
		e = e || window.event;
        e.preventDefault();
        if(e.repeat){return;}
		switch (e.key) {
			case "A": playTone(currentPitches[0]*.5,"key"); lightUI('x'); break; //key set 1
			case "S": playTone(currentPitches[1]*.5,"key"); lightUI('y'); break;
			case "D": playTone(currentPitches[2]*.5,"key"); lightUI('z'); break;
			case "F": playTone(currentPitches[3]*.5,"key"); lightUI('d'); break;
			case "Q": playTone(currentPitches[0],"key"); lightUI('x'); break;
			case "W": playTone(currentPitches[1],"key"); lightUI('y'); break;
			case "E": playTone(currentPitches[2],"key"); lightUI('z'); break;
			case "R": playTone(currentPitches[3],"key"); lightUI('d'); break;

			case "H": playTone(currentPitches[0]*.5,"key2"); lightUI('x'); break; //key set 2
			case "J": playTone(currentPitches[1]*.5,"key2"); lightUI('y'); break;
			case "K": playTone(currentPitches[2]*.5,"key2"); lightUI('z'); break;
			case "L": playTone(currentPitches[3]*.5,"key2"); lightUI('d'); break;
			case "Y": playTone(currentPitches[0],"key2"); lightUI('x'); break;
			case "U": playTone(currentPitches[1],"key2"); lightUI('y'); break;
			case "I": playTone(currentPitches[2],"key2"); lightUI('z'); break;
			case "O": playTone(currentPitches[3],"key2"); lightUI('d'); break;
		}		
}

const audioContext = new (window.AudioContext || window.webkitAudioContext)();

const masterVolume = audioContext.createGain();
masterVolume.connect(audioContext.destination);
masterVolume.gain.value = 0.8;

const volumeControl = document.getElementById('masterVol');
volumeControl.addEventListener('input', function(){
    masterVolume.gain.value = this.value;
});

let attackTime =0, sustainLevel=0, releaseTime=0, noteLength=0; panVal=0;

let osc ;
let sPan;

function get3dPanner(){
	let panner = audioContext.createPanner();
	//panner.panningModel = 'HRTF'; //here comes the crash in the YT video
	panner.distanceModel = 'linear';
	panner.refDistance = 1;
	panner.maxDistance = 100;
	panner.rolloffFactor = 1;
	panner.coneInnerAngle = 360;
	panner.coneOuterAngle = 0;
	panner.coneOuterGain = 0;
	return panner;
}

//DELAYS ARE PER INSTRUMENT
//PANNERS ARE PER NOTE
const i1Delay = audioContext.createDelay();
const i1Feedback = audioContext.createGain();
const i1DelayAmountGain = audioContext.createGain();

const i2Delay = audioContext.createDelay();
const i2Feedback = audioContext.createGain();
const i2DelayAmountGain = audioContext.createGain();

const i3Delay = audioContext.createDelay();
const i3Feedback = audioContext.createGain();
const i3DelayAmountGain = audioContext.createGain();

const i4Delay = audioContext.createDelay();
const i4Feedback = audioContext.createGain();
const i4DelayAmountGain = audioContext.createGain();

let sDelay;
let sFeedback;
let sDelayAmountGain;

let i1asrl, i2asrl, i3asrl, i4asrl;
function updateASRL(){
	i1asrl = [parseFloat(document.getElementById('fAttack').value),
				parseFloat(document.getElementById('fVolume').value),
				parseFloat(document.getElementById('fRelease').value),
				parseFloat(document.getElementById('fNLength').value),
				parseFloat(document.getElementById('fPan').value)];

	i3asrl = [parseFloat(document.getElementById('hAttack').value),
				parseFloat(document.getElementById('hVolume').value),
				parseFloat(document.getElementById('hRelease').value),
				parseFloat(document.getElementById('hNLength').value),
				parseFloat(document.getElementById('hPan').value)];

	i2asrl = [parseFloat(document.getElementById('gAttack').value),
				parseFloat(document.getElementById('gVolume').value),
				parseFloat(document.getElementById('gRelease').value),
				parseFloat(document.getElementById('gNLength').value),
				parseFloat(document.getElementById('gPan').value)];

	i4asrl = [parseFloat(document.getElementById('jAttack').value),
				parseFloat(document.getElementById('jVolume').value),
				parseFloat(document.getElementById('jRelease').value),
				parseFloat(document.getElementById('jNLength').value),
				parseFloat(document.getElementById('jPan').value)];
}
updateASRL();

//delay options
let i1delay, i2delay, i3delay, i4delay;
function updateDelay(){
	i1delay = [parseFloat(document.getElementById('fDelayTime').value),
				parseFloat(document.getElementById('fDelayFeedback').value),
				parseFloat(document.getElementById('fDelayAmount').value)];

	i3delay = [parseFloat(document.getElementById('hDelayTime').value),
				parseFloat(document.getElementById('hDelayFeedback').value),
				parseFloat(document.getElementById('hDelayAmount').value)];

	i2delay = [parseFloat(document.getElementById('gDelayTime').value),
				parseFloat(document.getElementById('gDelayFeedback').value),
				parseFloat(document.getElementById('gDelayAmount').value)];

	i4delay = [parseFloat(document.getElementById('jDelayTime').value),
				parseFloat(document.getElementById('jDelayFeedback').value),
				parseFloat(document.getElementById('jDelayAmount').value)];
}
updateDelay();

let setSlots = [0,0,0,0];
function updateSlots(){
	setSlots[0]=GetTrueOne('lc_slot');
	setSlots[1]=GetTrueOne('mc_slot');
	setSlots[2]=GetTrueOne('ks1_slot');
	setSlots[3]=GetTrueOne('ks2_slot');
}
updateSlots();

let setInsts = [0,0,0,0];
function updateInsts(){
	setInsts[0]=GetTrueOne('ins1_sel');
	setInsts[1]=GetTrueOne('ins2_sel');
	setInsts[2]=GetTrueOne('ins3_sel');
	setInsts[3]=GetTrueOne('ins4_sel');
}
updateInsts();

function playTone(freq,inp) {

	let stereopan = document.getElementById('pan3d').checked;
    function setASRL(i){
            attackTime = i[0];
			sustainLevel = i[1];
			releaseTime = i[2];
			noteLength = i[3];
			panVal = i[4];
    }

	function setFX(i){
		sDelay.delayTime.value = i[0];
	    sFeedback.gain.value = i[1];
		sDelayAmountGain.gain.value = i[2];
		sDelayAmountGain.connect(sDelay);
		sDelay.connect(sFeedback);
		sFeedback.connect(sDelay);
		sDelay.connect(masterVolume);
		//pan is setted
		sPan.connect(sDelayAmountGain);
	}

	let wslot;
	switch (inp) {
		case 0: wslot = setSlots[0]; break;
		case 1: wslot = setSlots[1]; break;
		case "key": wslot = setSlots[2]; break;
		case "key2": wslot = setSlots[3]; break;
		default:break;
	}

	function setInst(w){
		switch (w) {
				case 0:
					osc = audioContext.createOscillator();
					osc.type = "sine";
					osc.frequency.value = freq;
					break;

				case 1:
					osc = audioContext.createOscillator();
					osc.type = "square";
					osc.frequency.value = freq;
					break;

				case 2:
					osc = audioContext.createOscillator();
					osc.type = "triangle";
					osc.frequency.value = freq;					
					break;

				case 3:
					osc = audioContext.createOscillator();
					osc.type = "sawtooth";
					osc.frequency.value = freq;
					break;

				case 4:
					switch (wslot) {
						case 0: osc = gFF.CreateOscillator(freq); break;
						case 2: osc = gHH.CreateOscillator(freq); break;
						case 1: osc = gGG.CreateOscillator(freq); break;
						case 3: osc = gJJ.CreateOscillator(freq); break;
						default: break;
					}
					break;

				default:
					break;
			}
	}

	let winst;
	switch (wslot) {
		case 0: 
            setASRL(i1asrl);
			sPan = stereopan?get3dPanner():audioContext.createStereoPanner();
			if(document.getElementById('i1fx').checked==true){
				sDelay = i1Delay;
				sFeedback = i1Feedback;
				sDelayAmountGain = i1DelayAmountGain;
				setFX(i1delay);
			}
			winst = setInsts[0];
			setInst(winst);
			break;

		case 2: 
			setASRL(i3asrl);
			sPan = stereopan?get3dPanner():audioContext.createStereoPanner();
			if(document.getElementById('i3fx').checked==true){
				sDelay = i3Delay;
				sFeedback = i3Feedback;
				sDelayAmountGain = i3DelayAmountGain;
				setFX(i3delay);
			}
			winst = setInsts[2];
			setInst(winst);
			break;

		case 1: 
			setASRL(i2asrl);
			sPan = stereopan?get3dPanner():audioContext.createStereoPanner();
			if(document.getElementById('i2fx').checked==true){
				sDelay = i2Delay;
				sFeedback = i2Feedback;
				sDelayAmountGain = i2DelayAmountGain;
				setFX(i2delay);
			}
			winst = setInsts[1];
			setInst(winst);
			break;

		case 3:
			setASRL(i4asrl);
			sPan = stereopan?get3dPanner():audioContext.createStereoPanner();
			if(document.getElementById('i4fx').checked==true){
				sDelay = i4Delay;
				sFeedback = i4Feedback;
				sDelayAmountGain = i4DelayAmountGain;
				setFX(i4delay);
			}
			winst = setInsts[3];
			setInst(winst);
			break;

		default:
			break;
	}

    let noteGain = audioContext.createGain();
    noteGain.gain.setValueAtTime(0, 0);
    noteGain.gain.linearRampToValueAtTime(sustainLevel, audioContext.currentTime + noteLength * attackTime);
    noteGain.gain.setValueAtTime(sustainLevel, audioContext.currentTime + noteLength - noteLength * releaseTime);
    noteGain.gain.linearRampToValueAtTime(0, audioContext.currentTime + noteLength);    
    
    osc.start(0);
    osc.stop(audioContext.currentTime + noteLength);
    osc.connect(noteGain);
	if(stereopan){
		if(datanull[0]!=0){
			sPan.setPosition(datanull[0]-g_eye[0],datanull[1]-g_eye[1],datanull[2]-g_eye[2]);
		}/*else{
			sPan.setPosition(0,0,0);
		}*/
	}else{
		sPan.pan.value = panVal;
	}
	noteGain.connect(sPan);
	sPan.connect(masterVolume);
}

	let gGG;
	updateGG();
	function updateGG(){
		gGG = new PeriodicWaveInstrument(
        CreateWaveTablesFromFormants([
            [document.getElementById('g1freq').value, document.getElementById('g1exp').value, document.getElementById('g1coef').value],
			[document.getElementById('g2freq').value, document.getElementById('g2exp').value, document.getElementById('g2coef').value],
            [document.getElementById('g3freq').value, document.getElementById('g3exp').value, document.getElementById('g3coef').value],
			[document.getElementById('g4freq').value, document.getElementById('g4exp').value, document.getElementById('g4coef').value],
            [document.getElementById('g5freq').value, document.getElementById('g5exp').value, document.getElementById('g5coef').value]
        ], 
		document.getElementById('wtgg_numHarmonics').value, 
		document.getElementById('wtgg_attenuator').value,
		document.getElementById('wtgg_bandwith').value,
		document.getElementById('wtgg_bandwithScale').value,
		16384), 0.2);
	}

	var gFF;
	updateFF();
	function updateFF(){
		gFF = new PeriodicWaveInstrument(
        CreateWaveTablesFromFormants([
            [document.getElementById('f1freq').value, document.getElementById('f1exp').value, document.getElementById('f1coef').value],
			[document.getElementById('f2freq').value, document.getElementById('f2exp').value, document.getElementById('f2coef').value],
            [document.getElementById('f3freq').value, document.getElementById('f3exp').value, document.getElementById('f3coef').value],
			[document.getElementById('f4freq').value, document.getElementById('f4exp').value, document.getElementById('f4coef').value],
            [document.getElementById('f5freq').value, document.getElementById('f5exp').value, document.getElementById('f5coef').value]
        ], 
		Math.round(document.getElementById('wtff_numHarmonics').value-Math.round(datanull[3]*.2)), 
		document.getElementById('wtff_attenuator').value,
		document.getElementById('wtff_bandwith').value,
		document.getElementById('wtff_bandwithScale').value,
		16384), 0.2);
	}

	var gHH; //middle click default
	updateHH();
	function updateHH(){
			gHH = new PeriodicWaveInstrument(
			WaveTableGeneratorFromHarmonics([
				[document.getElementById('h1amp').value, document.getElementById('h1frm').value, document.getElementById('h1bw').value],
				[document.getElementById('h2amp').value, document.getElementById('h2frm').value, document.getElementById('h2bw').value],
				[document.getElementById('h3amp').value, document.getElementById('h3frm').value, document.getElementById('h3bw').value],
				[document.getElementById('h4amp').value, document.getElementById('h4frm').value, document.getElementById('h4bw').value],
				[document.getElementById('h5amp').value, document.getElementById('h5frm').value, document.getElementById('h5bw').value]
			], document.getElementById('wthh_numHarmonics').value, 8192), 0.2);
	}

	var gJJ;
	updateJJ();
	function updateJJ(){
		gJJ = new PeriodicWaveInstrument(
			WaveTableGeneratorFromHarmonics([
				//amp  freq mult    bandw
				[document.getElementById('j1amp').value, document.getElementById('j1frm').value, document.getElementById('j1bw').value],
				[document.getElementById('j2amp').value, document.getElementById('j2frm').value, document.getElementById('j2bw').value],
				[document.getElementById('j3amp').value, document.getElementById('j3frm').value, document.getElementById('j3bw').value],
				[document.getElementById('j4amp').value, document.getElementById('j4frm').value, document.getElementById('j4bw').value],
				[document.getElementById('j5amp').value, document.getElementById('j5frm').value, document.getElementById('j5bw').value]
			], document.getElementById('wtjj_numHarmonics').value, 8192), 0.2);
	}

    function CreateWaveTablesFromFormants(formants, numHarmonics, 
    harmonicAttenuationPower, bandwidth, bandwidthScale, tableSize) {
        return function (freq) {
            let ampls = new Float32Array(tableSize);
            for (let i = 1; i <= numHarmonics; i++) {
                let ifreq = i * freq;
                let amplitude = 0;
                for (let f = 0; f < formants.length; f++) {
                    let formant = formants[f];
                    let x = (ifreq - formant[0]) * formant[1];
                    amplitude += formant[2] * Math.exp(-x * x);
                }
                amplitude /= Math.pow(i, harmonicAttenuationPower);
                AddSineHarmonicGauss(ampls, freq / 4 / 16384,
                    i, bandwidthScale, amplitude, bandwidth);
            }
            return GenerateWaveWithRandomPhases(ampls);
        };
    }

    function WaveTableGeneratorFromHarmonics(harmonics, bandwidthScale, tableSize) {
        return function (freq) {
            let ampls = new Float32Array(tableSize);
            let len = harmonics.length;
            for (let i = 0; i < len; i++) {
                let harm = harmonics[i];
                AddSineHarmonicGauss(ampls, freq / 4 / 16384,
                    harm[1], bandwidthScale, harm[0], harm[2]);// harm[2]);
            }
            return GenerateWaveWithRandomPhases(ampls);
        };
    }

    function PeriodicWaveInstrument(waveGenerator, volume) {
        this.Volume = volume || 1;
        let waveNoteCache = [];
        this.CreateOscillator = function (freq) {
            if (!waveNoteCache[freq]) waveNoteCache[freq] = waveGenerator(freq);
            let osc = audioContext.createOscillator();
            let wave = waveNoteCache[freq];
            osc.frequency.value = 2 * 16384 / wave.length;
            osc.setPeriodicWave(wave);
            return osc;
        };
    }

    let gSineTable = function () {
        let tableLen = 32768;
        let table = new Float32Array(tableLen);
        let PI2_len = 2 * Math.PI / tableLen;
        for (let i = 0; i < tableLen; i++)
            table[i] = Math.sin(i * PI2_len);
        return table;
    }();

    function AddSineHarmonicGauss(dstAmpls, freqSampleRateRatio,
        harmFreqMultiplier, harmBandwidthScale, amplitude, bandwidthCents) {
        let bwi = (Math.pow(2, bandwidthCents / 1200 - 1) - 0.5) * freqSampleRateRatio;
        bwi *= Math.pow(harmFreqMultiplier, harmBandwidthScale);
        let rw = -freqSampleRateRatio * harmFreqMultiplier / bwi;
        let rdw = 1.0 / (dstAmpls.length * 2 * bwi);

        let startIndex = 0, endIndex = dstAmpls.length;

        let range = 2;
        if (rdw > 1) range = 3 * rdw;
        if (-range > rw) {
            startIndex = Math.round((-range - rw) / rdw);
            rw += startIndex * rdw;
        }
        if (rw < range) endIndex = startIndex + Math.max(10, Math.round((range - rw) / rdw));

        let ampl = amplitude / bwi;
        for (let i = startIndex; i < endIndex; i++) {
            dstAmpls[i] += ampl * Math.exp(-rw * rw);
            rw += rdw;
        }
    }
    let gSeed = 157898685;

    function GenerateWaveWithRandomPhases(ampls) {
        let len = ampls.length;
        let tableLen = gSineTable.length, tableMask = tableLen - 1;
        let real = new Float32Array(len);
        let imag = new Float32Array(len);
        let seed = gSeed;
        for (let i = 0; i < len; i++) {
            seed = (seed * 16807) & 0xFFFFFFFF;
            real[i] = ampls[i] * gSineTable[(seed + tableLen / 4) & tableMask];
            imag[i] = ampls[i] * gSineTable[seed & tableMask];
        }
        gSeed = seed;
        let result = audioContext.createPeriodicWave(real, imag, { disableNormalization: false });
        result.length = len;
        return result;
    }

//WEBGL UTILS
/*
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */


/**
 * @fileoverview This file contains functions every webgl program will need
 * a version of one way or another.
 *
 * Instead of setting up a context manually it is recommended to
 * use. This will check for success or failure. On failure it
 * will attempt to present an approriate message to the user.
 *
 *       gl = WebGLUtils.setupWebGL(canvas);
 *
 * For animated WebGL apps use of setTimeout or setInterval are
 * discouraged. It is recommended you structure your rendering
 * loop like this.
 *
 *       function render() {
 *         window.requestAnimFrame(render, canvas);
 *
 *         // do rendering
 *         ...
 *       }
 *       render();
 *
 * This will call your rendering function up to the refresh rate
 * of your display but will stop rendering if your app is not
 * visible.
 */

 WebGLUtils = function() {

/**
 * Creates the HTLM for a failure message
 * @param {string} canvasContainerId id of container of th
 *        canvas.
 * @return {string} The html.
 */
var makeFailHTML = function(msg) {
  return '' +
    '<table style="background-color: #8CE; width: 100%; height: 100%;"><tr>' +
    '<td align="center">' +
    '<div style="display: table-cell; vertical-align: middle;">' +
    '<div style="">' + msg + '</div>' +
    '</div>' +
    '</td></tr></table>';
};

/**
 * Mesasge for getting a webgl browser
 * @type {string}
 */
var GET_A_WEBGL_BROWSER = '' +
  'This page requires a browser that supports WebGL.<br/>' +
  '<a href="http://get.webgl.org">Click here to upgrade your browser.</a>';

/**
 * Mesasge for need better hardware
 * @type {string}
 */
var OTHER_PROBLEM = '' +
  "It doesn't appear your computer can support WebGL.<br/>" +
  '<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>';

/**
 * Creates a webgl context. If creation fails it will
 * change the contents of the container of the <canvas>
 * tag to an error message with the correct links for WebGL.
 * @param {Element} canvas. The canvas element to create a
 *     context from.
 * @param {WebGLContextCreationAttirbutes} opt_attribs Any
 *     creation attributes you want to pass in.
 * @param {function:(msg)} opt_onError An function to call
 *     if there is an error during creation.
 * @return {WebGLRenderingContext} The created context.
 */
var setupWebGL = function(canvas, opt_attribs, opt_onError) {
  function handleCreationError(msg) {
    var container = canvas.parentNode;
    if (container) {
      var str = window.WebGLRenderingContext ?
           OTHER_PROBLEM :
           GET_A_WEBGL_BROWSER;
      if (msg) {
        str += "<br/><br/>Status: " + msg;
      }
      container.innerHTML = makeFailHTML(str);
    }
  };

  opt_onError = opt_onError || handleCreationError;

  if (canvas.addEventListener) {
    canvas.addEventListener("webglcontextcreationerror", function(event) {
          opt_onError(event.statusMessage);
        }, false);
  }
  var context = create3DContext(canvas, opt_attribs);
  if (!context) {
    if (!window.WebGLRenderingContext) {
      opt_onError("");
    }
  }
  return context;
};

/**
 * Creates a webgl context.
 * @param {!Canvas} canvas The canvas tag to get context
 *     from. If one is not passed in one will be created.
 * @return {!WebGLContext} The created context.
 */
var create3DContext = function(canvas, opt_attribs) {
  var names = ["webgl", "experimental-webgl", "webkit-3d", "moz-webgl"];
  var context = null;
  for (var ii = 0; ii < names.length; ++ii) {
    try {
      context = canvas.getContext(names[ii], opt_attribs);
    } catch(e) {}
    if (context) {
      break;
    }
  }
  return context;
}

return {
  create3DContext: create3DContext,
  setupWebGL: setupWebGL
};
}();

/**
 * Provides requestAnimationFrame in a cross browser way.
 */
window.requestAnimFrame = (function() {
  return window.requestAnimationFrame ||
         window.webkitRequestAnimationFrame ||
         window.mozRequestAnimationFrame ||
         window.oRequestAnimationFrame ||
         window.msRequestAnimationFrame ||
         function(/* function FrameRequestCallback */ callback, /* DOMElement Element */ element) {
           window.setTimeout(callback, 1000/60);
         };
})();
</script>
</html>